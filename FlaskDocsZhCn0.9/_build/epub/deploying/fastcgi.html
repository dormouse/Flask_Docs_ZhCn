

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>FastCGI</title>
    
    <link rel="stylesheet" href="../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> 
  </head>
  <body>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="cgi.html" title="CGI"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="uwsgi.html" title="uWSGI"
             accesskey="P">上一页</a> |</li>
        <li><a href="../index.html">Flask 0.9 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">部署方式</a> &raquo;</li> 
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="fastcgi">
<span id="deploying-fastcgi"></span><h1>FastCGI</h1>
<p>FastCGI 是部署 Flask 的途径之一,类似的部署途径还有 <a class="reference external" href="http://nginx.org/">nginx</a><span class="link-target"> [http://nginx.org/]</span>  、 <a class="reference external" href="http://www.lighttpd.net/">lighttpd</a><span class="link-target"> [http://www.lighttpd.net/]</span> 和
<a class="reference external" href="http://www.cherokee-project.com/">cherokee</a><span class="link-target"> [http://www.cherokee-project.com/]</span> 。其他部署途径的信息参见 <a class="reference internal" href="uwsgi.html#deploying-uwsgi"><em>uWSGI</em></a> 和
<a class="reference internal" href="wsgi-standalone.html#deploying-wsgi-standalone"><em>独立 WSGI 容器</em></a> 。本文讲述的是使用 FastCGI 部署，因此先决条件
是要有一个 FastCGI 服务器。 <a class="reference external" href="http://trac.saddi.com/flup">flup</a><span class="link-target"> [http://trac.saddi.com/flup]</span> 最流行的 FastCGI 服务器之一，我们将会在本文
中使用它。在阅读下文之前先安装好 <a class="reference external" href="http://trac.saddi.com/flup">flup</a><span class="link-target"> [http://trac.saddi.com/flup]</span> 。</p>
<div class="admonition- admonition">
<p class="first admonition-title">小心</p>
<p class="last">请务必把 <tt class="docutils literal"><span class="pre">app.run()</span></tt> 放在 <tt class="docutils literal"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__':</span></tt> 内部或者放在单独
的文件中，这样可以保证它不会被调用。因为，每调用一次就会开启一个本地 WSGI
服务器。当我们使用 FastCGI 部署应用时，不需要使用本地服务器。</p>
</div>
<div class="section" id="fcgi">
<h2>创建一个 <cite>.fcgi</cite> 文件</h2>
<p>首先你必须创建 FastCGI 服务器配置文件，我们把它命名为 <cite>yourapplication.fcgi</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/python</span>
<span class="kn">from</span> <span class="nn">flup.server.fcgi</span> <span class="kn">import</span> <span class="n">WSGIServer</span>
<span class="kn">from</span> <span class="nn">yourapplication</span> <span class="kn">import</span> <span class="n">app</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">WSGIServer</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>如果使用的是 Apache ，那么使用了这个文件之后就可以正常工作了。但是如果使用的是
nginx 或老版本的 lighttpd ，那么需要显式地把接口传递给 FastCGI 服务器，即把接口
的路径传递给 <tt class="xref py py-class docutils literal"><span class="pre">WSGIServer</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">WSGIServer</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">bindAddress</span><span class="o">=</span><span class="s">&#39;/path/to/fcgi.sock&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>这个路径必须与服务器配置中定义的路径一致。</p>
<p>把这个 <cite>yourapplication.fcgi</cite> 文件放在一个以后可以找得到的地方，最好是
<cite>/var/www/yourapplication</cite> 或类似的地方。</p>
<p>为了让服务器可以执行这个文件，请给文件加上执行位，确保这个文件可以执行：</p>
<div class="highlight-text"><div class="highlight"><pre># chmod +x /var/www/yourapplication/yourapplication.fcgi
</pre></div>
</div>
</div>
<div class="section" id="apache">
<h2>配置 Apache</h2>
<p>上面的例子对于基本的 Apache 部署已经够用了，但是你的 <cite>.fcgi</cite> 文件会暴露在应用的
URL 中，比如 example.com/yourapplication.fcgi/news/ 。有多种方法可以避免出现这
中情况。一个较好的方法是使用 ScriptAlias 配置指令:</p>
<div class="highlight-python"><pre>&lt;VirtualHost *&gt;
    ServerName example.com
    ScriptAlias / /path/to/yourapplication.fcgi/
&lt;/VirtualHost&gt;</pre>
</div>
<p>如果你无法设置 ScriptAlias ，比如你使用的是一个共享的网络主机，那么你可以使用
WSGI 中间件把 yourapplication.fcgi 从 URL 中删除。你可以这样设置 .htaccess:</p>
<div class="highlight-python"><pre>&lt;IfModule mod_fcgid.c&gt;
   AddHandler fcgid-script .fcgi
   &lt;Files ~ (\.fcgi)&gt;
       SetHandler fcgid-script
       Options +FollowSymLinks +ExecCGI
   &lt;/Files&gt;
&lt;/IfModule&gt;

&lt;IfModule mod_rewrite.c&gt;
   Options +FollowSymlinks
   RewriteEngine On
   RewriteBase /
   RewriteCond %{REQUEST_FILENAME} !-f
   RewriteRule ^(.*)$ yourapplication.fcgi/$1 [QSA,L]
&lt;/IfModule&gt;</pre>
</div>
<p>设置 yourapplication.fcgi:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/python</span>
<span class="c">#: optional path to your local python site-packages folder</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;&lt;your_local_path&gt;/lib/python2.6/site-packages&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">flup.server.fcgi</span> <span class="kn">import</span> <span class="n">WSGIServer</span>
<span class="kn">from</span> <span class="nn">yourapplication</span> <span class="kn">import</span> <span class="n">app</span>

<span class="k">class</span> <span class="nc">ScriptNameStripper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="n">to_strip</span> <span class="o">=</span> <span class="s">&#39;/yourapplication.fcgi&#39;</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

   <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
       <span class="n">environ</span><span class="p">[</span><span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">ScriptNameStripper</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">WSGIServer</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="lighttpd">
<h2>配置 lighttpd</h2>
<p>一个 lighttpd 的基本 FastCGI 配置如下:</p>
<div class="highlight-python"><pre>fastcgi.server = ("/yourapplication.fcgi" =&gt;
    ((
        "socket" =&gt; "/tmp/yourapplication-fcgi.sock",
        "bin-path" =&gt; "/var/www/yourapplication/yourapplication.fcgi",
        "check-local" =&gt; "disable",
        "max-procs" =&gt; 1
    ))
)

alias.url = (
    "/static/" =&gt; "/path/to/your/static"
)

url.rewrite-once = (
    "^(/static.*)$" =&gt; "$1",
    "^(/.*)$" =&gt; "/yourapplication.fcgi$1"</pre>
</div>
<p>请记住启用 FastCGI 、 alias 和 rewrite 模块。以上配置把应用绑定到
<cite>/yourapplication</cite> 。如果你想要让应用在根 URL 下运行，那么必须使用
<a class="reference external" href="http://werkzeug.pocoo.org/docs/contrib/fixers/#werkzeug.contrib.fixers.LighttpdCGIRootFix" title="(in Werkzeug v0.9)"><tt class="xref py py-class docutils literal"><span class="pre">LighttpdCGIRootFix</span></tt></a><span class="link-target"> [http://werkzeug.pocoo.org/docs/contrib/fixers/#werkzeug.contrib.fixers.LighttpdCGIRootFix]</span> 中间件来解决一个
lighttpd 缺陷。</p>
<p>请确保只有应用在根 URL 下运行时才使用上述中间件。更多信息请阅读 <a class="reference external" href="http://redmine.lighttpd.net/wiki/lighttpd/Docs:ModFastCGI">FastCGI 和
Python</a><span class="link-target"> [http://redmine.lighttpd.net/wiki/lighttpd/Docs:ModFastCGI]</span>
（注意，已经不再需要把一个接口显式传递给 run() 了）。</p>
</div>
<div class="section" id="nginx">
<h2>配置 nginx</h2>
<p>在 nginx 上安装 FastCGI 应用有一些特殊，因为缺省情况下不传递 FastCGI 参数。</p>
<p>一个 nginx 的基本 FastCGI 配置如下:</p>
<div class="highlight-python"><pre>location = /yourapplication { rewrite ^ /yourapplication/ last; }
location /yourapplication { try_files $uri @yourapplication; }
location @yourapplication {
    include fastcgi_params;
    fastcgi_split_path_info ^(/yourapplication)(.*)$;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_param SCRIPT_NAME $fastcgi_script_name;
    fastcgi_pass unix:/tmp/yourapplication-fcgi.sock;
}</pre>
</div>
<p>这个配置把应用绑定到 <cite>/yourapplication</cite> 。如果你想要在根 URL 下运行应用非常
简单，因为你不必指出如何计算出 <cite>PATH_INFO</cite> 和 <cite>SCRIPT_NAME</cite>:</p>
<div class="highlight-python"><pre>location / { try_files $uri @yourapplication; }
location @yourapplication {
    include fastcgi_params;
    fastcgi_param PATH_INFO $fastcgi_script_name;
    fastcgi_param SCRIPT_NAME "";
    fastcgi_pass unix:/tmp/yourapplication-fcgi.sock;
}</pre>
</div>
</div>
<div class="section" id="id1">
<h2>运行 FastCGI 进程</h2>
<p>Nginx 和其他服务器不会载入 FastCGI 应用，你必须自己载入。 <a class="reference external" href="http://supervisord.org/configuration.html#fcgi-program-x-section-settings">Supervisor 可以管理
FastCGI 进程。</a><span class="link-target"> [http://supervisord.org/configuration.html#fcgi-program-x-section-settings]</span>
在启动时你可以使用其他 FastCGI 进程管理器或写一个脚本来运行 <cite>.fcgi</cite> 文件，例如
使用一个 SysV <tt class="docutils literal"><span class="pre">init.d</span></tt> 脚本。如果是临时使用，你可以在一个 GNU screen 中运行
<tt class="docutils literal"><span class="pre">.fcgi</span></tt> 脚本。运行细节参见 <tt class="docutils literal"><span class="pre">man</span> <span class="pre">screen</span></tt> ，同时请注意这是一个手动启动方法，
不会在系统重启时自动启动:</p>
<div class="highlight-python"><pre>$ screen
$ /var/www/yourapplication/yourapplication.fcgi</pre>
</div>
</div>
<div class="section" id="id2">
<h2>调试</h2>
<p>在大多数服务器上， FastCGI 部署难以调试。通常服务器日志只会告诉你类似
“ premature end of headers ”的内容。为了调试应用，查找出错的原因，你必须切换
到正确的用户并手动执行应用。</p>
<p>下例假设你的应用是 <cite>application.fcgi</cite> ，且你的网络服务用户为 <cite>www-data</cite>:</p>
<div class="highlight-python"><pre>$ su www-data
$ cd /var/www/yourapplication
$ python application.fcgi
Traceback (most recent call last):
  File "yourapplication.fcgi", line 4, in &lt;module&gt;
ImportError: No module named yourapplication</pre>
</div>
<p>上面的出错信息表示 &#8220;yourapplication&#8221; 不在 python 路径中。原因可能有：</p>
<ul class="simple">
<li>使用了相对路径。在当前工作路径下路径出错。</li>
<li>当前网络服务器设置未正确设置环境变量。</li>
<li>使用了不同的 python 解释器。</li>
</ul>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
        &copy; 版权所有 2012, Armin Ronacher.
    </div>
  </body>
</html>